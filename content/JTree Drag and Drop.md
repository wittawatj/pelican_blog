Title: JTree Drag and Drop 
Date: 2008-04-17 11:07:00
Tags:  
Slug: JTree Drag and Drop 


วันนี้กลับมาอ่านเรื่อง Drag and Drop (DnD) ใน Java อีกครั้งหลังจากที่เคยอ่านทิ้งไว้เมื่อปีที่แล้วจนลืมไปหมดแล้ว ที่ต้องมาอ่านเพราะว่าในโปรแกรม <a href="http://www.sansarn.com/offline/">Sansarn Offline</a> ที่กำลังทำ<span style="font-weight: bold;">ใหม่</span>อยู่นี้ จำเป็นต้องใช้ DnD ด้วย<br /><br />ใน Sansarn Offline ส่วนของ Admin จะมี tree อยู่สองฝั่ง(ซ้ายและขวา) ซึ่่งในเวอร์ชั่นก่อนๆ เวลาจะย้ายข้อมูลจากฝั่งขวามาฝั่งซ้าย จะให้ผู้ใช้เลือก node แม่ทางฝั่งซ้ายก่อน แล้วก็เลือก node ที่อยู่ฝั่งขวา แล้วก็กดปุ่ม import แล้ว node ฝั่งขวาก็จะมาเป็นลูกของ node ฝั่งซ้ายที่เลือกไว้<br /><br />วิธีที่กล่าวไปนี้จริงๆแล้วก็สามารถทำงานได้ แต่มีคอมเม้นท์เข้ามาว่ามันไม่เป็นธรรมชาติต่อผู้ใช้ เห็นได้จากตอนเปิดอบรมโปรแกรม ผู้ใช้จะพยายามใช้ mouse ลาก node ฝั่งขวาไปฝั่งซ้ายอยู่เรื่อย อาจจะด้วยความเคยชินกับโปรแกรมอื่นๆซึ่งทำได้<br /><br />เพราะฉะนั้นในเวอร์ชั่นใหม่ที่กำลังทำอยู่นี้ เลยต้องใส่ DnD เข้าไปให้ได้ มาเข้าเรื่อง DnD กันได้แล้ว DnD ที่จะเขียนในที่นี้อาจจะเน้นให้ใช้กับ JTree เป็นส่วนใหญ่ (จริงๆแล้ว DnD ไม่ได้จำกัดไว้ใช้กับแค่ JTree)<br /><br /><span style="font-weight: bold;">DnD :<br /></span><span>DnD หรือ Drag and Drop ก็คือการลากข้อมูลแล้วไปปล่อยไว้อีกทีนึงเพื่อโอนถ่ายข้อมูล แน่นอนทุกคนเคยใช้ เช่น ลาก icon บน desktop ไปใส่ในถังขยะ เป็นต้น ใน Java เราสามารถทำให้ทุก class ที่สืบทอด JComponent สนันสนุน DnD ได้ (Swing component ส่วนมากจะสืบทอดจาก JComponent เช่น JLabel, JTree, JTable, etc.)<br /><br />การทำงานของ DnD จะพึ่่งคลาส TransferHandler เป็นหลัก เป็นคลาสที่จะจัดการเรื่องการย้ายข้อมูลโดยใช้ DnD โดยปกติ Swing component จะ implement TransferHandler ให้อยู่แล้ว ยกเว้น JList, JTree, JTable เพราะว่า component สามอันนี้มันซับซ้อน จึงต้องสร้าง TransferHandler เองซะก่อนเพื่อใช้ DnD<br /><br />ข้อมูลที่จะย้ายได้โดยใช้ DnD นั้นสามารถเป็นข้อมูลของ class ใดก็ได้ เพียงแค่ class นั้น implement อินเตอร์เฟส Transferable ในตัวอย่างนี้เราต้องการจะลากไฟล์จาก tree ฝั่งขวามา tree ฝั่งซ้าย โดยข้อมูลเป็นลิสต์ของไฟล์ (สามารถเลือกหลายไฟล์และลากได้) เราก็เลยสร้าง class นึงขึ้นมา ชื่อ FileListTransferable เพื่อเป็น class ที่ทำหน้าที่เป็นข้อมูลขนย้าย คือ ลิสต์ของไฟล์นั่นแหละ<br /><br /><pre><br />class FileListTransferable implements Transferable {<br /><br />private List<file> fileList;<br /><br />private FileListTransferable(List<file> listFile) {<br />    this.fileList = listFile;<br />}<br /><br />public Object getTransferData(DataFlavor flavor) throws UnsupportedFlavorException, IOException {<br />    if (flavor.equals(DataFlavor.javaFileListFlavor)) {<br />        return fileList;<br />    }<br />    throw new UnsupportedFlavorException(flavor);<br />}<br /><br />public DataFlavor[] getTransferDataFlavors() {<br />    return new DataFlavor[]{DataFlavor.javaFileListFlavor};<br />}<br /><br />public boolean isDataFlavorSupported(DataFlavor flavor) {<br />    if (flavor.equals(DataFlavor.javaFileListFlavor)) {<br />        return true;<br />    }<br />    return false;<br />}<br />}<br /></file></file></pre><br /><br />การสร้าง Transferable จะต้อง implement 3 methods รายละเอียดของให้ลองๆอ่านดู แต่หลักๆในสาม method นั้นจะพูดเรื่อง DataFlavor ซึ่งเป็น class ที่ใช้อธิบายข้อมูลที่เราต้องการจะขนย้าย ในกรณีนี้พอดีว่าเจ้าลิสต์ของไฟล์น่ะมันเป็นของใช้บ่อย Java มันเลยมี DataFlavor ให้แล้ว ซึ่งเรียกได้จาก DataFlavor.javaFileListFlavor สำหรับ DataFlavor แบบอื่นๆเราสามารถ implement ขึ้นเองได้ แต่จะไม่กล่าวถึงในที่่นี้ เหตุผลเพราะเราก็ไม่รู้ว่าทำยังไง....<br /><br />มาถึงขั้นตอนการสร้างตัวขนย้ายข้อมูล นั่นคือ TransferHandler เราก็สร้าง TransferHandler ขึ้นมาใหม่ </span><span>(สร้าง class ใหม่แล้ว extends TransferHandler) </span><span>โดยมี method ที่ต้องสร้างใหม่ คือ<br /></span><ul><li>boolean canImport(TransferSupport support)<br /></li><li>Transferable createTransferable(JComponent c)<br /></li><li>int getSourceActions(JComponent c)</li><li> boolean importData(TransferSupport support)<br /></li></ul>รายละเอียดก็เยอะพอควร แต่สามารถหาอ่านได้จากเว็บของ sun (แหะๆ ขี้เกียจเขียน) ที่คิดว่่ายากคือ method ที่ชื่อ createTransferable method นี้เอาไว้สร้างข้อมูลที่จะขนย้ายโดย DnD มันจะถูกเรียกเมื่อผู้ใช้โปรแกรมเริ่มลากเม้าส์ object ของ class <span>FileListTransferable ข้างบนจะถูกสร้างใน method นี้<br /><br />พอทำ TransferHandler เสร็จก็ แค่ตั้ง JTree ให้สามารถ Drag ได้โดยเรียก tree.setDragEnabled(true); แล้วก็ตั้งตัวทำหน้าที่ขนย้ายโดย tree.setTransferHandler(new FileListTransferable(...)) แค่นี้ก็เสร็จแล้ว ถ้าอยากจะบังคับให้ drop ลงบน node เท่านั้น (ไม่อนุญาตให้ drop ระหว่าง node) ก็ทำได้โดย tree.setDropMode(DropMode.ON)<br /></span><span><br /></span><br />ที่มา:<br /><ul><li><a href="http://java.sun.com/docs/books/tutorial/uiswing/dnd/intro.html">http://java.sun.com/docs/books/tutorial/uiswing/dnd/intro.html<br /></a></li> อ่านอันนี้ดีที่สุด<li><a href="http://weblogs.java.net/blog/shan_man/archive/2006/01/first_class_dra.html">http://weblogs.java.net/blog/shan_man/archive/2006/01/first_class_dra.html</a></li><li><a href="http://weblogs.java.net/blog/shan_man/archive/2006/02/choosing_the_dr.html">http://weblogs.java.net/blog/shan_man/archive/2006/02/choosing_the_dr.html</a><br /></li></ul>
