Title: การใช้ CountDownLatch ใน Java เพื่อรองานย่อย 
Date: 2009-08-18 04:42:57
Tags: java 
Slug: การใช้ CountDownLatch ใน Java เพื่อรองานย่อย 


ในการเขียนโปรแกรมมีหลายครั้งที่เราต้องแบ่งงานใหญ่เป็นงานย่อยๆ แล้วทำงานย่อยเหล่านั้นพร้อมๆกัน แล้วตอนท้ายเราก็ต้องรอให้งานย่อยทุกอันทำเสร็จก่อนจึงจะไปต่อได้

สมมติเรามีเอกสารอยู่เยอะๆในฐานข้อมูล แล้ววันหนึ่งมีเอกสารใหม่เข้ามา เราอยากรู้ว่าเอกสารใหม่นั้นเกี่ยวข้องกับเอกสารใดในฐานข้อมูลที่เรามีอยู่บ้าง วิธีหนึ่งก็คือ (เป็นตัวอย่าง อาจไม่ใช่วิธีที่ดีที่สุด) เอาเอกสารใหม่นั้นมาจับคู่กับทุกๆเอกสารที่มีอยู่ซะ แล้วดูว่ามันเกี่ยวกันมั้ยโดยใช้ตัววัดอะไรบางอย่าง หากเรามี N เอกสารในฐานข้อมูล เราก็จะจับคู่ N คู่ นั่นคือ (เอกสารใหม่, เอกสาร1), (เอกสารใหม่, เอกสาร2), ..., (เอกสารใหม่, เอกสารN) จะเห็นว่าเราต้องทำทั้งสิ้น N ครั้ง

ความจริงแล้วเราไม่ต้องทำเรียงกันตั้งแต่เอกสารเบอร์ 1 ไปก็ได้ เราสามารถแตกเป็นงานย่อยเพื่อให้การหาความเกี่ยวข้องนี้เร็วขึ้น อย่างเช่น เราอาจจะสร้าง Thread ขึ้นมา 10 อันโดยให้
<ul>
	<li>Thread 1 ทำงาน {(เอกสารใหม่, เอกสาร1), (เอกสารใหม่, เอกสาร2),..., (เอกสารใหม่, เอกสาร N/10)}</li>
	<li>Thread 2 ทำงาน {(เอกสารใหม่, เอกสาร 1+N/10), (เอกสารใหม่, เอกสาร 2+N/10),..., (เอกสารใหม่, เอกสาร N/10+N/10)}</li>
	<li>Thread  ......</li>
	<li>Thread 10 ทำงาน {(เอกสารใหม่, เอกสาร 1+9N/10), (เอกสารใหม่, เอกสาร 2+9N/10),..., (เอกสารใหม่, เอกสาร N)}</li>
</ul>
ประเด็นคือว่ามีเหตุผลบางประการที่ทำให้เราต้องรอทุกๆ Thread เสร็จก่อน จึงจะไปทำอย่างอื่นต่อ เหมือนกับการแข่งรถที่รถแข่ง (รถแข่ง = Thread) แต่ละคันสามารถสตาร์ทเครื่องเมื่อไหร่ก็ได้ ไม่พร้อมกัน แต่ว่าแต่ละคันต้องออกวิ่งพร้อมกัน จุดนี้เราสามารถใช้ CountDownLatch มาแก้ปัญหาได้

CountDownLatch เป็น class หนึ่งใน java.util.concurrent หลักการก็คือ เราจะใช้ตัวเลขจำนวนเต็มบวกเป็นจุดเริ่มของการนับถอยหลัง จากตัวอย่างข้างบนเรามี 10 Thread เราก็นับถอยหลังจาก 10 เมื่อ Thread ตัวไหนทำงานจบแล้วก็ให้ลบตัวเลขนี้ไป 1 โปรแกรมจะรอจนกว่าตัวเลขนี้เป็น 0 ถึงจะไปต่อได้ ต่อไปนี้เป็น code ตัวอย่าง

[java]
public findRelations() throws InterruptedException{
  int threadCount = 10;
  CountDownLatch countDown  = new CountDownLatch(threadCount);
  for(int i=0;i&lt;threadCount;++i){
   Thread t = new Thread(new RelationDiscoveryTask(countDown));
   t.start(); //สั่งเริ่มงานย่อย
  }
  endSignal.await(); //block จนกว่างานย่อยจบหมด (เมื่อนับถอยหลังถึง 0 นั่นเอง)
  //มาถึงบรรทัดนี้ก็แปลว่าทุก Thread ทำงานเสร็จหมดแล้ว
  //... ทำอย่างอื่นต่อได้...
}
//////////////////
class RelationDiscoveryTask implements Runnable {

  private CountDownLatch endSignal;

  RelationDiscoveryTask(CountDownLatch c){
    endSignal = c;
  }
  public void run(){

    //หาความเกี่ยวข้องของข่าวตรงนี้

    //.....
    //ทำงานย่อยเสร็จแล้ว
    endSignal.countDown(); //เรียก countDown() บน CountDownLatch เพื่อให้นับถอยหลัง

  }

}

[/java]

ข้อมูลเพิ่มเติม:
<ul>
	<li><a href="http://java.sun.com/javase/6/docs/api/java/util/concurrent/CountDownLatch.html">http://java.sun.com/javase/6/docs/api/java/util/concurrent/CountDownLatch.html</a></li>
</ul>
